@using EventEase.Models
@inject EventEase.Services.UserSessionService UserSession

<div class="card mb-3">
    <div class="card-body">
        <h5 class="card-title">@Event.Title</h5>
        <p class="card-text">@Event.Description</p>
        <p class="card-text">
            <small class="text-muted">
                üìÖ @Event.Date.ToString("MMM dd, yyyy") | üìç @Event.Location
            </small>
        </p>
        <p class="card-text">
            <span class="badge bg-info">@Event.RegisteredUsers.Count/@Event.MaxAttendees attendees</span>
        </p>
        
        @if (IsEditable)
        {
            <div class="mb-3">
                <label class="form-label">Title:</label>
                <input @bind="Event.Title" @bind:event="oninput" class="form-control" />
            </div>
            <div class="mb-3">
                <label class="form-label">Description:</label>
                <textarea @bind="Event.Description" @bind:event="oninput" class="form-control" rows="3"></textarea>
            </div>
            <div class="mb-3">
                <label class="form-label">Date:</label>
                <input @bind="Event.Date" type="datetime-local" class="form-control" />
            </div>
            <div class="mb-3">
                <label class="form-label">Location:</label>
                <input @bind="Event.Location" @bind:event="oninput" class="form-control" />
            </div>
            <div class="mb-3">
                <label class="form-label">Max Attendees:</label>
                <input @bind="Event.MaxAttendees" type="number" min="1" class="form-control" />
            </div>
        }
        
        @if (UserSession.IsLoggedIn && !IsEditable)
        {
            <button @onclick="RegisterForEvent" class="btn btn-primary" disabled="@IsRegistrationDisabled">
                @(Event.RegisteredUsers.Contains(UserSession.CurrentUser!) ? "Registered" : "Register")
            </button>
        }
    </div>
</div>

@code {
    [Parameter] public Event Event { get; set; } = new();
    [Parameter] public bool IsEditable { get; set; } = false;
    [Parameter] public EventCallback<Event> OnRegister { get; set; }

    private bool IsRegistrationDisabled => 
        Event.RegisteredUsers.Count >= Event.MaxAttendees || 
        Event.RegisteredUsers.Contains(UserSession.CurrentUser ?? "");

    private async Task RegisterForEvent()
    {
        if (UserSession.IsLoggedIn && OnRegister.HasDelegate)
        {
            await OnRegister.InvokeAsync(Event);
        }
    }
}